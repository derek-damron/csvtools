#! /bin/bash

DELIM=','
while getopts h:f:r:p: OPT; do
    case $OPT in
        \?|h)
            echo "csv-sample: Randomly sample a proportion of a data set."
            echo "useage:"
            echo "  csv-sample -f <delimited file> [-d <delim>] -p <proportion>"
            exit 0
            ;;
        f)
            FILE=$OPTARG
            ;;
        r)
            HEADERFILE=$OPTARG
            ;;
        p)
            PROP=$OPTARG
            ;;
    esac
done

if [[ $FILE == '' ]]; then
    echo "csv-sample: Argument -f required." >&2
    exit 1
fi
if [[ $PROP == '' ]]; then
    echo "csv-sample: Argument -p required." >&2
    exit 1
fi

# Count the number of records in the file, then offset by one if
# the header is included.
NREC=$(cat $FILE | wc -l)
if [[ $HEADERFILE == '' ]]; then
    NREC=$(echo "$NREC - 1" | bc -l)
fi

# cut -d. -f1 == floor
NTOTAKE=$(echo "$NREC * $PROP" | bc -l | cut -d. -f1)

# Output the header if its neccessary
if [[ $HEADERFILE == '' ]]; then
    TAILARG='+2'
    cat $FILE | head -1
else
    TAILARG='+1'
fi

cat $FILE | tail -n $TAILARG | shuf -n $NTOTAKE
