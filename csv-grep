#! /bin/bash

DELIM=','
QUO='"'
while getopts h?d:f:c:p: OPT; do
    case $OPT in
        \?|h)
            echo "csv-grep: select rows from a csv acocrding to a pattern."
            echo "useage:"
            echo "  csv-grep -f <delimited file> [-d <delim>] [-q <quoting char>]"
            echo "           -c <column name> -p <pattern>"
            exit 0
            ;;
        d)
            DELIM=$OPTARG
            ;;
        q)
            QUO=$OPTARG
            ;;
        f)
            FILE=$OPTARG
            ;;
        c)
            COL=$OPTARG
            ;;
        p)
            PATTERN=$OPTARG
            ;;
    esac
done

COLIDX=$(csv-getcolidx -f $FILE -d $DELIM -c $COL)
if [[ $? != 0 ]]; then
    exit 1
fi

# Call the binary.
if [[ $QUO == '"' ]]; then
    { cat $FILE | head -1 ; \
      ./bin/grep $FILE $DELIM '"' $COLIDX $PATTERN
    }
elif [[ $QUO == "'" ]]; then
    { cat $FILE | head -1 ; \
      ./bin/grep $FILE $DELIM "'" $COLIDX $PATTERN
    }
else
    { cat $FILE | head -1 ; \
      ./bin/grep $FILE $DELIM $QUO $COLIDX $PATTERN
    }
fi
